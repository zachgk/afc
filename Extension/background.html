<html>

<script>

var wk = 0;
var wk2 = 0;

function request_create(){
	increase_charity_views(1);
    chrome.tabs.getSelected(null, function(tab) {
      chrome.tabs.sendRequest(tab.id, {action: "create"});
    });
}



function save_ad_positions(data) {
  var db = openDatabase('mydb','1.0','adsforcharity database', 5*1024*1024);
  db.transaction( function(tx){
    tx.executeSql('CREATE TABLE IF NOT EXISTS site_positions(id unique,site, top, left)');
    tx.executeSql('DELETE FROM site_positions WHERE site = "' + data.url + '"');
    for(i=0; i<data.positions.length ;i++){
      tx.executeSql('INSERT INTO site_positions(site, top, left) VALUES ("' + data.url + '", "'+ data.positions[i].top +'", "'+ data.positions[i].left +'")');
    }
  });
}

function site_interactions() {
	chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab){
	  if(changeInfo && changeInfo.url && changeInfo.url.indexOf("http://ads4charity.org")!= -1){
		chrome.tabs.executeScript(tabId, {"file":"site_interactions.js"});
	  }
	});
}

function startup_info(url) {
  var db = openDatabase('mydb','1.0','adsforcharity database', 5*1024*1024);
  db.transaction( function(tx){
    tx.executeSql('SELECT * FROM site_positions WHERE site = "'+ url +'"',[], function(tx, results){
      wk = new Array();
      for(i=0; i< results.rows.length; i++){
        wk2 = {top: results.rows.item(i).top, left: results.rows.item(i).left}; 
        wk.push ( wk2 );        
      }
      startup_ads(wk);     
    });
  });
}

function startup_ads(positions){
  increase_charity_views(positions.length);
  chrome.tabs.getSelected(null, function(tab) {
    chrome.tabs.sendRequest(tab.id, {action: "startup_ads", "positions": positions});
  });
}

function increase_charity_views(amount){
  if(localStorage['charity-' + localStorage.charity ]){
    localStorage['charity-' + localStorage.charity ]= Number(localStorage['charity-' + localStorage.charity ]) + amount;
  } else {
    localStorage['charity-' + localStorage.charity ] = amount;
  }
}

        //End Functions and begin stuff loaded on page start

chrome.extension.onRequest.addListener( function(request, sender, sendResponse){
  if(request.action == "create"){ //request from popup
    request_create();
    sendResponse({});
  } else if(request.action == "drag"){    //request from popup
    request_drag();
    sendResponse({});
  } else if(request.action == "remove"){ //request from popup
    request_remove();
    sendResponse({});
  } else if(request.action == "save_ad_positions"){
    save_ad_positions(request);
    sendResponse({});
  } else if(request.action == "request_startup_info"){
    startup_info(request.url)
    sendResponse({});
  } else if(request.action == "set_charity"){
    localStorage.charity = request.charity;
    sendResponse({});
  } else if(request.action == "get_charity"){
    sendResponse({"charity":localStorage.charity});
  } else if(request.action == "get_local_storage"){
    sendResponse({"localStorage":localStorage});
  } else{}
});


site_interactions();



</script>
</head>
<body>
</body>
</html>