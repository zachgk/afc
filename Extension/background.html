<html>
<script>

var wk, wk2;

function request_create(){
	increase_charity_views(1);
    chrome.tabs.getSelected(null, function(tab) {
      chrome.tabs.sendRequest(tab.id, {action: "create"});
    });
}

function save_ad_positions(data) {
  var db = openDatabase('a4c_db','1.0','adsforcharity database', 5*1024*1024);
  db.transaction( function(tx){
    tx.executeSql('CREATE TABLE IF NOT EXISTS site_positions(id unique,site, top, left, right)');
    tx.executeSql('DELETE FROM site_positions WHERE site = "' + data.url + '"');
    for(i=0; i<data.positions.length ;i++){
      tx.executeSql('INSERT INTO site_positions(site, top, left, right) VALUES ("' + data.url + '", "'+ data.positions[i].top +'", "'+ data.positions[i].left+'", "'+ data.positions[i].right +'")');
    }
  });
}

function startup_info(url) {
  var db = openDatabase('a4c_db','1.0','adsforcharity database', 5*1024*1024);
  db.transaction( function(tx){
    tx.executeSql('SELECT * FROM site_positions WHERE site = "'+ url +'"',[], function(tx, results){
      wk = new Array();
      for(i=0; i< results.rows.length; i++){
        wk2 = {top: results.rows.item(i).top, left: results.rows.item(i).left, right: results.rows.item(i).right}; 
        wk.push ( wk2 );        
      }
      startup_ads(wk);     
    });
  });
}

function startup_ads(positions){
  increase_charity_views(positions.length);
  chrome.tabs.getSelected(null, function(tab) {
    chrome.tabs.sendRequest(tab.id, {action: "startup_ads", "positions": positions});
  });
}

function increase_charity_views(amount){
  if(localStorage['charity-' + localStorage.charity ]){
    localStorage['charity-' + localStorage.charity ]= Number(localStorage['charity-' + localStorage.charity ]) + amount;
  } else {
    localStorage['charity-' + localStorage.charity ] = amount;
  }
}

    //Message passing functions

chrome.extension.onRequest.addListener( function(request, sender, sendResponse){
  if(request.action == "create"){ //request from popup
    request_create();
    sendResponse({});
  } else if(request.action == "save_ad_positions"){
    save_ad_positions(request);
    sendResponse({});
  } else if(request.action == "request_startup_info"){
    startup_info(request.url)
    sendResponse({});
  } else if(request.action == "set_charity"){
    localStorage.charity = request.charity;
    sendResponse({});
  } else if(request.action == "get_charity"){
    sendResponse({"charity":localStorage.charity});
  } else if(request.action == "get_local_storage"){
    sendResponse({"localStorage":localStorage});
  } else if(request.action == "display_message"){
    sendResponse({"formated_message":noty_message(request.message, request.type, request.time)});
  } else{}
});

function noty_message(message, type, time) { //Helper function for creating Noty settings
	//Default message parameters
	time = typeof time !== 'undefined' ? time : 1600; //time to autoclose the message
	type = typeof type !== 'undefined' ? type : "success"; //"success" is the default message type
	
	return {"text":message,"layout":"topRight","type":type,"animateOpen":{"height":"toggle"},"animateClose":{"height":"toggle"},"speed":500,"timeout":time,"closeButton":true,"closeOnSelfClick":true,"closeOnSelfOver":false,"modal":false};  //return the formatted options
}
</script>
</head>
<body>
</body>
</html>