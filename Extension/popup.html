<html>
<link href="popup_styles.css" rel="stylesheet" type="text/css">
<script>
function close_popup() {
	chrome.tabs.getSelected(null, function(tab) {
		chrome.tabs.update(tab.id, { selected: true } )
	});
}
function create(){
  chrome.extension.sendRequest({action: "create"});
  close_popup();  
}

function options(){
  chrome.tabs.create({"url":chrome.extension.getURL("fancy-settings/source/index.html")});
  close_popup();  
}

function revert(){
	chrome.tabs.getSelected(null,function(tab) {
		chrome.tabs.sendRequest(tab.id, {action: "remove_all_ads"});
		chrome.tabs.sendRequest(tab.id, {action:"get_url"}, function(response){
			var url = response.url;
			var db = openDatabase('a4c_db','1.0','adsforcharity database', 5*1024*1024);
			db.transaction( function(tx){
				tx.executeSql('DELETE FROM blacklist WHERE url = "'+ url +'"');
				revert_message();
				close_popup();
			});
		});
	});		
}

function blacklist(){
	chrome.tabs.getSelected(null,function(tab) {
		chrome.tabs.sendRequest(tab.id, {action:"get_url"}, function(response){
			var url = response.url;
			var db = openDatabase('a4c_db','1.0','adsforcharity database', 5*1024*1024);
			db.transaction( function(tx){
				tx.executeSql('INSERT INTO blacklist(url) VALUES("'+ url +'") ');
				close_popup();
			});
		});
		chrome.tabs.sendRequest(tab.id, {action: "remove_all_ads"});
	});
}

function startup_check(){
	chrome.tabs.getSelected(null,function(tab) {
		chrome.tabs.sendRequest(tab.id, {action:"get_url"}, function(response){		var url = response.url;
		var db = openDatabase('a4c_db','1.0','adsforcharity database', 5*1024*1024);
		db.transaction( function(tx){
			tx.executeSql('SELECT * FROM site_positions WHERE site = "'+ url +'"',[], function(tx, results){
			  is_blacklisted(url,results.rows.length);     
		});
	  });
	});
	});
}

function is_blacklisted(url, number_of_ads){
  var db = openDatabase('a4c_db','1.0','adsforcharity database', 5*1024*1024);
  db.transaction( function(tx){
    tx.executeSql('SELECT * FROM blacklist WHERE url = "'+ url +'"',[], function(tx, results){
	  blacklist_check_exception(url, number_of_ads, results.rows.length);
    });
  });
}

function blacklist_check_exception(url, number_of_ads, blacklisted){
  var db = openDatabase('a4c_db','1.0','adsforcharity database', 5*1024*1024);
  db.transaction( function(tx) {
    tx.executeSql('SELECT * FROM exceptions WHERE url = "'+ url +'"',[], function(tx, results){
	  button_correction(number_of_ads, blacklisted + results.rows.length);
	});
  });
}

function button_correction(number_of_ads, blacklisted){
  if (number_of_ads != 0 && localStorage['store.settings.autoAds'] != '"No Automation"') { //using template, with ads
    document.getElementById("revert").style.display="inline";
  }
  if (number_of_ads != 0 && localStorage['store.settings.autoAds'] == '"No Automation"') { //no template, with ads
    document.getElementById("revert").style.display="inline";
    document.getElementById("revert").innerHTML = 'Remove all Ads';      
  }   
  if (blacklisted && number_of_ads == 0 && localStorage['store.settings.autoAds'] != '"No Automation"') { //blacklisted, no ads, using template
    document.getElementById("revert").style.display="inline";
  }
  if (!blacklisted && number_of_ads == 0 && localStorage['store.settings.autoAds'] != '"No Automation"') { //not blacklisted, no ads, using template
    document.getElementById("blacklist").style.display="inline";
    document.getElementById("blacklist").innerHTML = 'Hide Ads';
  }
}

function revert_message() {
  chrome.tabs.getSelected(null,function(tab) {
		chrome.tabs.sendRequest(tab.id, {action: "revert_message"});
	});		
}

</script>

<button onclick="create()" title="Control+F3">Create Ad</button>
<button id="blacklist" onclick="blacklist()" title="Control+F2"style='display: none;'>Hide Advertisements</button>
<button id="revert" onclick="revert()" title="Control+F2" style='display: none;'>Revert to Template</button>
<button onclick="options();">Options</button>

<script>
startup_check();
</script>
</html>